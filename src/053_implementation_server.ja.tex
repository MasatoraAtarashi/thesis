\section{サーバ側実装}
サーバ側はWebAPIと、PDFからページ数を抽出するためのモジュールであり、それぞれRuby on Rails、Golangを用いて実装した。
WebAPIについては、認証関連API・コンテンツ関連API・フォルダ関連APIの3種類のAPIの実装について説明する。
その後、PDFからページ数を抽出するためのモジュールの実装について述べる。

\subsection{WebAPI}
本節では、WebAPIの実装について述べる。

\subsubsection{認証関連API}
本項では、認証に関連するAPIについて説明する。
メールアドレスおよびパスワードでの認証機能の実装には、Devise\cite{devise}、DeviseTokenAuth\cite{devise-token-auth}というgem\footnote{プログラミング言語Rubyにおけるライブラリのこと}を使用している。
会員登録用のAPIでは、リクエストにメールアドレス・パスワード・確認用パスワードの3つを要求する。
メールアドレスがすでに使用されている場合や、パスワードと確認用パスワードの値が異なる場合は、エラーレスポンスを返す。
リクエストに問題がない場合、パスワードのハッシュ値を計算し、データベースに保存する。
そして、ヘッダに認証用トークンを含めてレスポンスを返す。
コンテンツ関連APIやフォルダ関連APIを利用する場合は、この認証トークンをヘッダに追加してリクエストを送ることで、自動的に認証する。

ログイン用のAPIでは、リクエストとしてメールアドレスとパスワードを受け取り、パスワードのハッシュ値を計算する。
その計算結果とデータベースに保存されたパスワードのハッシュ値を比較し、一致した場合は認証する。

外部サービスを通じた認証機能の実装には、Omniauth\cite{omniauth}・Omniauth Twitter\cite{omniauth-twitter}・Omniauth GitHub\cite{omniauth-github}・Omniauth Google Oauth2\cite{omniauth-google-oauth2}というgemを使用している。

\subsubsection{コンテンツ関連API}
本項では、ブックマークの操作に関連するAPIについて説明する。


% ブックマークのCRUDを提供する。
コンテンツ関連APIでは、ブックマークしたコンテンツに対するCRUD\footnote{データリソースの操作に必要とされる機能(Create/Read/Update/Delete)}を実行できるAPIを提供している。

加えて、ブックマークの保存時にコンテンツの種類を自動的に判定し、メタデータとして保存する。
この時、コンテンツの種類がPDFであった場合には、URLのフラグメントにページ数を付与する。

その他、サーバ側ではサムネイル画像が存在しない場合にデフォルトの画像URLを設定したり、保存日時の追加などの処理も行う。

\subsubsection{フォルダ関連API}
本項では、フォルダの操作に関連するAPIについて説明する。
フォルダ関連APIでは、フォルダに対するCRUDを実行できるAPIを提供している。
加えて、フォルダにブックマークを追加・削除したり、特定のフォルダ内のブックマークを取得するAPIを提供している。

\subsection{PDFからページ数を抽出するモジュール}
本項では、PDFからページ数を抽出し、ブックマークとともに保存する機能について説明する。
クライアント側のブックマーク保存モジュールからPDFの画面キャプチャが送信されると、サーバ側はCarrierWave\cite{carrier-wave}というgemを使用してストレージにキャプチャをアップロードする。
ストレージにはAWSのS3\cite{s3}を使用している。

S3に画面キャプチャがアップロードされると、第一のAWS Lambdaがトリガーされる。
このLambdaは、AWSのTextract\cite{textract}というサービスのAPIを呼び出し、保存された画像をOCRにかける。

TextractはOCRによって抽出した文字列をDetectDocumentTextOutput\cite{detect-document-text-output}という構造体に含めて返却する。

LambdaはTextractのレスポンスから、PDFのページ数を抽出する。
DetectDocumentTextOutputは画像内に存在する英数字の一覧をリスト形式で持っている。
そのリストから、以下の正規表現\ref{regix-pdf-page-num}と初めにマッチする文字列を抽出する(例: 4/41)。
この文字列の初めの数字(例: 上記の例の場合、4)を、保存時のPDFのページ数とする。
PDFビューワでは画面上部のナビゲーションバーに現在のページ数を表示している。
そのため、正規表現にマッチした文字列のうち一番初めに現れたものが、PDFの現在のページ数である可能性が高い。

% textlint-disable
\begin{itembox}[l]{保存時のPDFのページ数を取得するために用いる正規表現}
  \label{regix-pdf-page-num}
  \begin{verbatim}
    `(\d+)\/\d+`
  \end{verbatim}
\end{itembox}
% textlint-enable

なお、ページ数の抽出が失敗した場合は、その時点で処理を中止し、アップロードされたファイルを削除する。

第一のLambdaの実行が終わると、2番目のLambdaがトリガーされる。
このLambdaは、取得したPDFのページ数をWebAPIを通じてデータベースに保存する。そのために、このLambdaはブックマークのpdf\_page\_numカラムのみを変更する権限を持つ。
保存が完了すると、Lambdaはアップロードされた画面キャプチャを削除する。

上記の一連の実装内容を図\ref{fig:impl-pdf-overall}にまとめる。

\begin{figure}[htbp]
  \caption{PDFページ数抽出機能の実装の全体像}
  \label{fig:impl-pdf-overall}
  \begin{center}
    \includegraphics[bb=0 0 480 532,width=12cm]{img/050_implementation/server/impl-pdf-overall.pdf}
  \end{center}
\end{figure}

\section{まとめ}
本章では、Web-Snapshotシステムの実装について述べた。
次章では、本システムを利用して実際にWebページをブックマークし、閲覧状態の復元を評価する。