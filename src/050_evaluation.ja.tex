\chapter{評価}
\label{chap:evaluation}

本章では、ESP32マイコンとPC上で同一のWebAssemblyプログラムを実行することで、それぞれの環境における実行性能を比較し、マイコンにおけるWebAssembly実行環境の性能を考察する。

\section{評価手法}

\subsection{WebAssemblyバイナリ}
\label{subsec:wasm}

各実行環境で実行する同一のWebAssemblyプログラムとして、与えられた整数$n$に対して$n+1$番目のフィボナッチ数を返す関数$fib(n)$をC言語で実装した。

\begin{itembox}[l]{フィボナッチ関数のC言語による実装}
  \begin{verbatim}
    int fib(int n) {
      if (n <= 1) return 1;
      return fib(n - 1) + fib(n - 2);
    }
  \end{verbatim}
\end{itembox}

この関数のコンパイルには、LLVM/Clang 7.0.1を用いた。
LLVMのWebAssembly対応は試験的なものであるため、LLVMおよびClangコンパイラ自体を{\tt LLVM\_EXPERIMENTAL\_TARGETS\_TO\_BUILD}フラグに{\tt WebAssembly}を指定してソースコードからビルドした。

このLLVM/Clangを用いて{\tt fib}関数をコンパイルし、85バイトのWebAssemblyバイナリを得た。
WebAssemblyバイナリのコンパイル時に設定したオプションを表\ref{tab:compiler}に示す。

\begin{table}[htbp]
  \label{tab:compiler}
  \caption{WebAssemblyバイナリのコンパイル時に指定したオプション}
  \begin{center}
    \begin{tabular}{ll}
    \hline
    \verb|--target=wasm32-unknown-unknown-wasm| & WebAssemblyバイナリ \\
    & （wasm32）を生成する \\ \hline
    \verb|-s| & バイナリサイズを最適化し、 \\
    & デバッグ情報などを含めない \\ \hline
    \verb|-O3| & プログラムを最大レベルで最適化する \\ \hline
    \verb|-nostdlib| \verb|-nostartfiles| & 標準起動ファイルや\\
    & 標準ライブラリを使用しない \\ \hline
    \verb|--fvisibility=default| & 全ての関数をモジュール外 \\
    & から参照可能にする \\ \hline
    \verb|-Wl,--no-entry| & エントリーポイントが存在 \\
    & しないことを警告しない \\ \hline
    \end{tabular}
  \end{center}
\end{table}

\newpage

\section{実行速度}

\ref{subsec:wasm}項の方法によりコンパイルしたWebAssemblyバイナリを、\ref{chap:implementation}章で述べた各環境上のホストプログラムに埋め込み、libwasmを用いて0から30までの$n$について関数を呼び出した。

0から30までの各$n$について\verb|fib|関数を実行した時の時間と、macOS環境に対してESP32環境で実行に必要なクロック数を表\ref{tab:fib_time}に示した。
実行に必要なクロック数の比較は、各環境で計測された実行時間にそれぞれのCPUのクロック周波数を乗じ、比を求めた。
すなわち、ESP32環境における実行はmacOS環境における実行に対して、$n=0$や$n=1$の時に約7倍、$n=10$の時に約11倍、$n=30$の時に約15倍のクロック数が必要だった。

\begin{table}[htbp]
  \caption{libwasmを用いた{\tt fib}関数の実行時間と、必要なクロック数の比}
  \label{tab:fib_time}
  \begin{center}
    \begin{tabular}{rrrr}
      \hline
         & macOS環境での & ESP32環境での & 実行に必要な \\
       n & 実行時間（$\mu$s） & 実行時間（$\mu$s） & クロック数の比 \\ \hline \hline
       0 &         3 &           267 &  7.1 倍 \\ \hline
       1 &         3 &           259 &  6.9 倍 \\ \hline
       2 &         9 &           916 &  7.8 倍 \\ \hline
       3 &        15 &         1,564 &  8.1 倍 \\ \hline
       4 &        25 &         2,799 &  8.9 倍 \\ \hline
       5 &        42 &         4,742 &  9.0 倍 \\ \hline
       6 &        70 &         7,994 &  9.0 倍 \\ \hline
       7 &       118 &        13,302 &  9.0 倍 \\ \hline
       8 &       161 &        22,046 & 10.9 倍 \\ \hline
       9 &       287 &        36,400 & 10.1 倍 \\ \hline
      10 &       408 &        59,973 & 11.7 倍 \\ \hline
      % 11 &       648 &        98,676 & 12.1 倍 \\ \hline
      % 12 &     1,432 &       162,208 &  9.0 倍 \\ \hline
      % 13 &     2,354 &       266,487 &  9.0 倍 \\ \hline
      % 14 &     3,642 &       437,590 &  9.6 倍 \\ \hline
      15 &     5,022 &       718,329 & 11.4 倍 \\ \hline
      % 16 &     8,608 &     1,178,811 & 10.9 倍 \\ \hline
      % 17 &    13,815 &     1,933,996 & 11.2 倍 \\ \hline
      % 18 &    22,328 &     3,172,256 & 11.3 倍 \\ \hline
      % 19 &    35,609 &     5,202,283 & 11.6 倍 \\ \hline
      20 &    52,961 &     8,529,805 & 12.8 倍 \\ \hline
      % 21 &    83,772 &    13,983,115 & 13.3 倍 \\ \hline
      % 22 &   134,115 &    22,918,957 & 13.6 倍 \\ \hline
      % 23 &   216,433 &    37,558,837 & 13.8 倍 \\ \hline
      % 24 &   349,573 &    61,540,310 & 14.0 倍 \\ \hline
      25 &   562,661 &   100,818,119 & 14.3 倍 \\ \hline
      % 26 &   909,827 &   165,139,586 & 14.5 倍 \\ \hline
      % 27 & 1,455,711 &   270,457,743 & 14.8 倍 \\ \hline
      % 28 & 2,353,144 &   442,878,521 & 15.0 倍 \\ \hline
      % 29 & 3,847,535 &   725,117,084 & 15.0 倍 \\ \hline
      30 & 6,237,998 & 1,187,057,130 & 15.2 倍 \\ \hline
    \end{tabular}
  \end{center}
\end{table}

次に、Webブラウザ環境における実行性能を計測した。
Webブラウザ環境macOS環境と同じアーキテクチャにJITコンパイルされるため、求めたESP32環境とmacOS環境における実行性能の比を用いて、ESP32においてブラウザと同等の実行効率が得られた際の実行性能を近似して推測することができる。

計測したWebブラウザ環境における実行時間と、推測したESP32における性能について、Webブラウザ環境における実行時間が1マイクロ秒以上となった$n\leq12$の場合を、表\ref{tab:fib_time_browser}に示す。
ESP32においてブラウザと同等の実行効率が得られた場合、$n=20$の時に約3ミリ秒、$n=30$の時に約560ミリ秒の実行時間となることが推測された。

センサーから入力される数値の加工や外部装置の制御など、マイコンで一般的に想定される処理内容と比較して、フィボナッチ数の計算は引数$n$に応じて演算回数および関数呼び出し回数の両方が極端に多くなる処理である。
そのため、マイコンにおける一般的な処理であれば実用的な演算速度で行えると考えられる。

\begin{table}[htbp]
  \caption{Webブラウザにおける実行時間と、推測されるESP32上での実行時間}
  \label{tab:fib_time_browser}
  \begin{center}
    \begin{tabular}{rrr}
      \hline
         & Webブラウザ環境での & ESP32での \\
       n & 実行時間（$\mu$s） & 実行時間（推測、$\mu$s） \\ \hline \hline
      12 &     1 &     113 \\ \hline
      13 &     1 &     113 \\ \hline
      14 &     2 &     240 \\ \hline
      15 &     3 &     429 \\ \hline
      % 16 &     4 &     548 \\ \hline
      % 17 &     6 &     840 \\ \hline
      % 18 &    10 &   1,421 \\ \hline
      % 19 &    15 &   2,191 \\ \hline
      20 &    24 &   3,865 \\ \hline
      % 21 &    39 &   6,510 \\ \hline
      % 22 &    63 &  10,766 \\ \hline
      % 23 &   102 &  17,701 \\ \hline
      % 24 &   168 &  29,575 \\ \hline
      25 &   272 &  48,737 \\ \hline
      % 26 &   431 &  78,229 \\ \hline
      % 27 &   697 & 129,496 \\ \hline
      % 28 & 1,127 & 212,109 \\ \hline
      % 29 & 1,818 & 342,625 \\ \hline
      30 & 2,941 & 559,656 \\ \hline
    \end{tabular}
  \end{center}
\end{table}

\section{メモリフットプリント}

ESP32環境での実行について、メモリフットプリントとしてヒープ領域に確保されるメモリの最大量を計測した。
なお、スタックサイズは150000バイトに設定した。
引数\verb|n|を0から13まで変化させた際の、関数実行のメモリフットプリントの推移を表\ref{tab:heap_size}に示す。

定数を返すのみである$n=0$および$n=1$の時、メモリフットプリントは540バイトで、実行速度と同様に変化はなかった。
再帰的な関数呼び出しが発生する$n=2$以降は、208バイトずつ上昇していった。
これは、WebAssembly実行環境のスタックにおけるメモリ消費であると考えられる。

150キロバイト程度の未確保領域があることを踏まえると、関数実行における280バイトのオーバーヘッドは実用的な範囲として許容できると考えられる。

\begin{table}[htbp]
  \caption{ESP32環境におけるメモリフットプリントの推移}
  \label{tab:heap_size}
  \begin{center}
    \begin{tabular}{rrrr}
      \hline
      & 未確保領域 & 起動からの確保量 & 変化量 \\
      & （バイト） & （バイト） & （バイト） \\ \hline \hline
      起動後      & 152,636 & - & - \\ \hline
      パース後     & 152,600 & 36 & 36 \\ \hline
      インスタンス化後 & 152,440  & 196 & 160 \\ \hline
      $n=0$  & 152,096 &   540 & 344 \\ \hline
      1  & 152,096 &   540 &   0 \\ \hline
      2  & 151,816 &   820 & 280 \\ \hline
      3  & 151,536 & 1,100 & 280 \\ \hline
      4  & 151,256 & 1,380 & 280 \\ \hline
      5  & 150,976 & 1,660 & 280 \\ \hline
      % 6  & 150,696 & 1,940 & 280 \\ \hline
      % 7  & 150,416 & 2,220 & 280 \\ \hline
      % 8  & 150,136 & 2,500 & 280 \\ \hline
      % 9  & 149,856 & 2,780 & 280 \\ \hline
      10 & 149,576 & 3,060 & 280 \\ \hline
      % 11 & 149,296 & 3,340 & 280 \\ \hline
      % 12 & 149,016 & 3,620 & 280 \\ \hline
      % 13 & 148,736 & 3,900 & 280 \\ \hline
      % 14 & 148,456 & 4,180 & 280 \\ \hline
      15 & 148,176 & 4,460 & 280 \\ \hline
      % 16 & 147,896 & 4,740 & 280 \\ \hline
      % 17 & 147,616 & 5,020 & 280 \\ \hline
      % 18 & 147,336 & 5,300 & 280 \\ \hline
      % 19 & 147,056 & 5,580 & 280 \\ \hline
      20 & 146,776 & 5,860 & 280 \\ \hline
      % 21 & 146,496 & 6,140 & 280 \\ \hline
      % 22 & 146,216 & 6,420 & 280 \\ \hline
      % 23 & 145,936 & 6,700 & 280 \\ \hline
      % 24 & 145,656 & 6,980 & 280 \\ \hline
      25 & 145,376 & 7,260 & 280 \\ \hline
      % 26 & 145,096 & 7,540 & 280 \\ \hline
      % 27 & 144,816 & 7,820 & 280 \\ \hline
      % 28 & 144,536 & 8,100 & 280 \\ \hline
      % 29 & 144,256 & 8,380 & 280 \\ \hline
      30 & 143,976 & 8,660 & 280 \\ \hline
    \end{tabular}
  \end{center}
\end{table}
